---
title: "2019 - 2020 Covid-19 outbreak"
author: "Linlin Sun"
date: "3/10/2020"
output:
  pdf_document: default
  html_document: default
---

# Background

The 2019-2020 Covid-19 outbreak is an ongoing global outbreak of Covid-19 disease 2019 that has been declared a Public Health Emergency of International Concern. It is caused by the SARS-CoV-2 Covid-19, first identified in Wuhan, Hubei, China. Over 100 countries and territories have been affected at the beginning of March 2020 with major outbreaks in central China, South Korea, Italy, Iran, France, and Germany. 

# Background of the author. 
As a newbie in the data science world, I would like to use the Covid-19 data to practice my data wrangling skills. 
As a Chinese-American, I have spent more than half of my life here in US than in China. I have paid attention to the news in China while Wuhan and other places in China were experiencing the covid-19 spreading. Now, I am experiencing covid-19 spread in US. Beside trying my best to do the social distancing, I would like to make my small portion of contribution to the covid-19 analysis. 

I am hoping we will get through this soon and wish the best for everyone!

## Data files

I have been referring to [Johns Hopkins CSSE Covid-19](
https://gisanddata.maps.arcgis.com/apps/opsdashboard/index.html#/bda7594740fd40299423467b48e9ecf)

https://gisanddata.maps.arcgis.com/apps/opsdashboard/index.html#/bda7594740fd40299423467b48e9ecf 
for affected cases. From their website, they provided a [github link](https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_time_series) containing the data they are using to populate the website. 

I got the world population information from [https://www.worldometers.info/world-population/population-by-country/](
https://www.worldometers.info/world-population/population-by-country/)

Including the library. 

```{r, message = FALSE, results = 'hide'}
library(tidyverse)
library(lubridate)
library(matrixStats)
library(kableExtra)
options(digits=2)
```

Loading the data. 

```{r, message = FALSE, results = 'hide', echo = FALSE}
# c_ts <- read.csv("../input/covid19/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv", header = TRUE)
# c_ts_col_count <- length(colnames(c_ts))
# d_ts <- read.csv("../input/covid19/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Deaths.csv", header = TRUE)
# d_ts_col_count <- length(colnames(d_ts))
# r_ts <- read.csv("../input/covid19/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Recovered.csv", header = TRUE)
# r_ts_col_count <- length(colnames(r_ts))

```

```{r, message = FALSE, results = 'hide'}
path <- getwd()
covid_Confirmed_ts <- "data/time_series_covid_19_confirmed_global.csv"
covid_Deaths_ts <- "data/time_series_covid_19_deaths_global.csv"

c_ts <- read.csv(paste(path, covid_Confirmed_ts, sep = "/"), header = TRUE)
c_ts_col_count <- length(colnames(c_ts))
d_ts <- read.csv(paste(path, covid_Deaths_ts, sep = "/"), header = TRUE)
d_ts_col_count <- length(colnames(d_ts))
```


Here is what the time series data look like. I am showing only partial columns due to space issue. 

```{r, echo = FALSE}
knitr::kable(c_ts[1:5, c(1, 2, (c_ts_col_count-5):c_ts_col_count)], 
             caption = "Sample entries of time_series_covid_19_confirmed_global.csv")
```

I would like to just focus on US case growth. I woould like to have a plot to simply show how the total confirmed US cases grows each day. 



```{r}
confirmed <- c_ts %>% select(-Province.State, -Lat, -Long) %>%
    gather(Date_temp, value, -Country.Region) %>%
    group_by(Country.Region, Date_temp) %>%
    summarize(Confirmed = sum(value)) %>%
    ungroup() %>%
    mutate(Date_temp = str_replace(Date_temp, "X", "")) %>%
    mutate(Date = as.POSIXct(strptime(Date_temp, "%m.%d.%y")))

deaths <- d_ts %>% select(-Province.State, -Lat, -Long) %>%
    gather(Date_temp, value, -Country.Region) %>%
    group_by(Country.Region, Date_temp) %>%
    summarize(Deaths = sum(value)) %>%
    ungroup() %>%
    mutate(Date_temp = str_replace(Date_temp, "X", "")) %>%
    mutate(Date = as.POSIXct(strptime(Date_temp, "%m.%d.%y")))

confirmed_deaths <- cbind(confirmed[, c(1, 4)], confirmed[, 3], deaths[3])

str(confirmed_deaths)

today <- max(confirmed$Date)

```

```{r}
select_top <- 15
top_confirmed_countries <- confirmed %>% filter(Date == today) %>% 
    arrange(desc(Confirmed)) %>% 
    top_n(select_top, Confirmed) %>% 
    mutate(Country.Region = as.character(Country.Region)) %>% 
    .$Country.Region

# confirmed %>% filter(Country.Region == "United Kingdom")

confirmed %>% filter(Country.Region %in% top_confirmed_countries) %>% 
    ggplot(aes(Date, Confirmed, color = Country.Region)) +
    geom_point(size = 0.1) + 
    geom_line() +
    theme(plot.title = element_text(hjust = 0.5),
          plot.subtitle = element_text(hjust = 0.5)) +
    labs(title = paste("Timeline for Covid-19 Confirmed Cases as of", today, sep = " "),
         subtitle = "Showing countries with top 15 most confirmed cases in the world", 
         x = "Date", 
         y = "Confirmed case count",
         caption = "datasource: https://github.com/CSSEGISandData/COVID-19",
         color = "Country")
```


```{r}

# Day1 plot
day1_count <- 100

confirmed_day1 <- confirmed %>% filter(Confirmed >= day1_count) %>% group_by(Country.Region) %>% 
    arrange(Confirmed) %>% mutate(Day = row_number()) %>% ungroup()

x_lim_max <- confirmed_day1 %>% filter(Country.Region %in% top_confirmed_countries) %>% 
  filter(Country.Region != top_confirmed_countries[1]) %>% 
  arrange(desc(Day)) %>% 
  select(Day) %>% 
  summarize(max_day = max(Day)) %>% 
  pull(max_day)

  
confirmed_day1 %>% filter(Country.Region %in% top_confirmed_countries) %>%
    ggplot(aes(Day, Confirmed, color = Country.Region)) +
    geom_point(size = 0.1) + 
    geom_line() +
    theme(plot.title = element_text(hjust = 0.5),
          plot.subtitle = element_text(hjust = 0.5)) +
    xlim(1, x_lim_max) +
    labs(title = paste("Timeline for Covid-19 Confirmed Cases as of", today, sep = " "),
         subtitle = "Showing countries with top 15 most confirmed cases in the world\nDay 1 starts with around 100 case count for each country", 
         x = "Day", 
         y = "Confirmed case count",
         caption = "datasource: https://github.com/CSSEGISandData/COVID-19",
         color = "Country")



```


```{r}
source("WorldPopulation.R")
wp <- getWorldPopulation()

```

```{r}
wppd <- wp %>% 
    mutate(Density = str_replace_all(Density, ",", "")) %>% 
    mutate(Density = as.numeric(Density)) %>% 
    mutate(Population = str_replace_all(Population, ",", "")) %>% 
    mutate(Population = as.numeric(Population)) %>% 
    select(Country.Region, Density, Population, Median_Age)

confirmed_deaths <- confirmed_deaths %>% mutate(Country.Region = as.character(Country.Region))

all <- left_join(confirmed_deaths %>% filter(Date == today), wppd, by = "Country.Region")

# sapply(all, function(col) {sum(is.na(col))})
unique(all[is.na(all$Density),]$Country.Region)
# Three countries do not get a matching density

# There are two Congo entries in covid-19 data, one congo entry from the world population data
all$Density[str_detect(all$Country.Region, "Congo")] <- 
    wppd$Density[wppd$Country.Region == "Congo"]

all$Population[str_detect(all$Country.Region, "Congo")] <-
    wppd$Population[wppd$Country.Region == "Congo"]/2

# Cruise ship is not a real country. 
all$Density[str_detect(all$Country.Region, "Cruise Ship")] <- 10
all$Population[str_detect(all$Country.Region, "Cruise Ship")] <-2000
```


```{r}
all <- all %>% 
    mutate("D/C %" = (Deaths/Confirmed)*100) %>% 
    mutate("C/Population" = (Confirmed/Population)*10000, 
           "D/Population" = (Deaths/Population)*10000) %>%
    mutate("D/C % by Density" = `D/C %`/Density) %>% 
    arrange(desc(Confirmed)) %>% slice(1:15)

knitr::kable(all,
  caption = paste("World Covid-19 Summary", today, "C/Population, D/Population, R/Population are per 10,000 people", sep = " "),
  format="latex", booktabs=TRUE) %>%
  kable_styling(latex_options="scale_down")

```



## Below are my personal opinion from this table. I could be wrong. Please let me know what you think. I will really appreciate it. 
On websites, we normally see the numbers for Confirmed, Deaths, Recovered. Some places might show the Death rate which is calculated as Deaths/Confirmed. 

I added population, density and median age of the countries to the table. I calculated the number of cases (Confirmed, Deaths) divided by population multipled by 10,000. So C/Population and D/Population columns shows number of cases per 10,000 people. 

"D/C by Density" is calculated by Deaths/Confirmed divided by country density. (Density here is number of people per square km). So this rate removes the density factor. If a country has higher density, that makes the virus to be transmitted more easily. 


1. If not considering the population and density factors, China has the highest confirmed case. Italy has the highest 
Deaths/Confirmed rate (D/C %). 

2. Adding consideration of the countries' population, Italy has the highest Confirmed and Death cases per 10,000 people. 

3. Adding the consideration of population density, Iran has relative high Deaths/Confirmed by density. Italy is not on the top of this list.

4. For most of the countries which have higher confirmed cases, most of them have D/C % by Density within 0.05. This means to me that the virus transmission seems to be similar across all countries. 

5. There can be other factors that contribute to D/C % by Density. If a country has more people older than a certain age, it will be more affected since covid-19 has much worse impact on older people. Italy is a great exmaple. Better medical facilities will have positive effect on this. 





